// ===============================================
// HONEYLABS - Estructura de base de datos Prisma
// ===============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
//  ENTIDAD
// Representa una empresa o instituci贸n oficial.
//
model Entidad {
  id              Int       @id @default(autoincrement())        // ID 煤nico autoincremental
  nombre          String                                         // Nombre de la entidad
  tipo            String                                         // 'empresarial' o 'institucional'
  correoContacto  String                                         // Correo principal de contacto
  telefono        String?                                        // Tel茅fono de contacto (opcional)
  direccion       String?                                        // Direcci贸n f铆sica (opcional)
  fechaCreacion   DateTime  @default(now())                      // Fecha de registro autom谩tico
  usuarios        Usuario[]                                      // Relaci贸n: usuarios que pertenecen a esta entidad
  almacenes       Almacen[]                                      // Relaci贸n: almacenes asociados a esta entidad
  roles           Rol[]                                          // Relaci贸n: roles personalizados de esta entidad
}

//
//  USUARIO
// Cuenta de acceso al sistema: individual, empresarial o institucional.
//
model Usuario {
  id             Int       @id @default(autoincrement())         // ID 煤nico
  nombre         String                                           // Nombre del usuario
  apellidos      String                                           // Apellidos completos
  correo         String    @unique                               // Correo 煤nico (login principal)
  contrasena     String                                           // Contrase帽a hasheada (bcrypt)
  googleId       String?                                          // ID de cuenta Google (opcional)
  tipoCuenta     String                                           // 'estandar', 'empresarial', 'institucional'
  estado         String    @default("pendiente")                 // Estado: pendiente, activo, rechazado
  fechaRegistro  DateTime  @default(now())                       // Fecha de creaci贸n de cuenta

  // Relaci贸n con entidad (opcional si es cuenta individual)
  entidadId      Int?
  entidad        Entidad?   @relation(fields: [entidadId], references: [id])

  // Relaci贸n con roles globales o internos
  roles          Rol[]                                           // Roles asignados al usuario
  almacenes      UsuarioAlmacen[]                                // Relaci贸n intermedia con almacenes

  //  Nuevos campos para control avanzado de registro
  codigoUsado    String?                                         // C贸digo de invitaci贸n utilizado (si aplica)
  archivoNombre  String?                                         // Nombre del archivo de validaci贸n (PDF/IMG)
  archivoBuffer  Bytes?                                          // Archivo en s铆 (guardado en BLOB, opcional)
}

//
//  ROL
// Define permisos agrupados, asignables a usuarios. Pueden ser globales o propios de entidad.
//
model Rol {
  id          Int       @id @default(autoincrement())            // ID 煤nico
  nombre      String                                             // Nombre identificador (admin, editor...)
  descripcion String?                                            // Explicaci贸n del rol (opcional)
  permisos    String                                             // Lista de permisos (como texto o JSON)
  
  // Relaci贸n con entidad (opcional si es rol global)
  entidadId   Int?
  entidad     Entidad?  @relation(fields: [entidadId], references: [id])

  usuarios    Usuario[]                                          // Usuarios que tienen este rol
}

//
//  ALMACN
// Espacio virtual de trabajo para una entidad, con control por roles.
//
model Almacen {
  id                      Int       @id @default(autoincrement())// ID 煤nico
  nombre                  String                                   // Nombre del almac茅n
  descripcion             String?                                  // Descripci贸n (opcional)
  imagenUrl               String?                                  // Imagen o icono del almac茅n (opcional)
  codigoUnico             String   @unique                         // C贸digo 煤nico de invitaci贸n (tipo Classroom)
  funciones               String?                                  // Lista o JSON de m贸dulos habilitados
  permisosPredeterminados String?                                  // Reglas para nuevos usuarios por c贸digo

  fechaCreacion           DateTime  @default(now())                // Fecha de creaci贸n

  // Relaci贸n con entidad propietaria
  entidadId               Int
  entidad                 Entidad   @relation(fields: [entidadId], references: [id])

  // Relaciones m煤ltiples
  usuarios                UsuarioAlmacen[]                         // Usuarios con acceso a este almac茅n
  codigos                 CodigoAlmacen[]                          // C贸digos hist贸ricos o activos del almac茅n
}

//
//  USUARIO ALMACN
// Relaci贸n intermedia para gestionar permisos por almac茅n.
//
model UsuarioAlmacen {
  id             Int      @id @default(autoincrement())           // ID 煤nico
  usuarioId      Int                                          
  almacenId      Int                                          
  rolEnAlmacen   String                                           // Rol espec铆fico en ese almac茅n (admin, consulta...)
  permisosExtra  String?                                          // Permisos individuales en texto o JSON

  usuario        Usuario  @relation(fields: [usuarioId], references: [id])
  almacen        Almacen  @relation(fields: [almacenId], references: [id])

  @@unique([usuarioId, almacenId])                               // Evita duplicados por almac茅n
}

//
//  CDIGO ALMACN
// C贸digos de acceso al almac茅n con permisos predefinidos.
//
model CodigoAlmacen {
  id              Int      @id @default(autoincrement())          // ID 煤nico
  almacenId       Int                                          
  codigo          String   @unique                                // C贸digo de acceso 煤nico
  rolAsignado     String                                         // Rol autom谩tico al usar este c贸digo
  permisos        String?                                        // Permisos extra al registrarse (JSON)
  usosDisponibles Int?                                           // N煤mero de usos permitidos (null = ilimitado)
  activo          Boolean  @default(true)                         // Control de activaci贸n/desactivaci贸n
  fechaCreacion   DateTime @default(now())                        // Fecha de creaci贸n
  fechaExpiracion DateTime?                                      // Fecha de expiraci贸n (opcional)
  creadoPorId     Int?                                           // Usuario o entidad que cre贸 el c贸digo

  almacen         Almacen  @relation(fields: [almacenId], references: [id])
}
